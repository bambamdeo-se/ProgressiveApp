function InitImageMaintenance(n,t){LoadTemplates();AddDragEvents();LoadImages(n,t)}function LoadTemplates(){var u=document.getElementById("ImageTemplate").innerHTML,n,t,i,r;ImageTemplate=Handlebars.compile(u);n=document.getElementById("LoadingImagesTemplate").innerHTML;LoadingImagesTemplate=Handlebars.compile(n);t=document.getElementById("NoImageUploadedTemplate").innerHTML;NoImageUploadedTemplate=Handlebars.compile(t);i=document.getElementById("PreviewImageTemplate").innerHTML;PreviewImageTemplate=Handlebars.compile(i);r=document.getElementById("UploadingImageTemplate").innerHTML;UploadingImageTemplate=Handlebars.compile(r)}function LoadImages(n,t){ClearAllCheckItemImages();LoadImagesForCheckItems(n,t,!0)}function LoadImagesForCheckItems(n,t){return $.each($("li[id='checkid'"),function(n,t){$(t).fadeIn(FadeInDelay);var i=LoadingImagesTemplate();$("ul#CheckItemImages").append(i).fadeIn(FadeInDelay)}),$.ajax({type:"POST",url:"/Trip/GetImages",data:{TripId:t},datatype:"html",success:function(i){ImagesLoadedJSON(i,n,t)}}),!1}function ClearAllCheckItemImages(){$("li.checkitem_imagelist").each(function(){$(this).fadeOut(FadeOutDelay)});$("ul.image_list li").each(function(){$(this).fadeOut(FadeOutDelay).remove()})}function ImageUploadSuccess(n){var i,r;if(n.response==null||n.response.length==null||n.response.length<1){alert("An error occurred during upload:  No files were returned.  Please reload the page.");return}var t=JSON.parse(n.response),u=t[0].Contextid,f=t[0].TripId;ClearAllImagesForCheckId();ImagesForCheckItemLoaded(u,f,t);i=$("#files").data().kendoUpload;r=i.wrapper.find(".k-file");$(r).fadeOut(FadeOutDelay);setTimeout(function(){i._removeFileEntry(r);CloseCheckItemFileUploadProgressPopup()},500)}function AddCheckItemImage(n,t,i,r){var o=new Date(i.ModifiedDate),s=o.toLocaleDateString("en-US"),u=i.ImageId,n=n,h=i.ModifiedUserFirstName,f,e;f=ImageTemplate({ContextId:n,ImageId:u,TripId:t,ModifiedDate:s,ModifiedUserName:h});e=$("ul #CheckItemImages");e.append(f);r==!0?$("li#Image_"+u.toString()+" div.image-wrapper").fadeIn(FadeInDelay):$("li#Image_"+u.toString()+" div.image-wrapper").show()}function ImagesLoadedJSON(n,t,i){var r=JSON.parse(n);$.each(r,function(n,r){AddCheckItemImage(t,i,r)});$("li[id^='LoadingImages']").remove();$(".checkitem_imagelist").each(function(n,t){var i=$(t).find("ul.image_list"),u=$(i).find("li").length,r;u<1&&(r=NoImageUploadedTemplate(),$(i).append(r).fadeIn(FadeInDelay))})}function DisableImageListByCheckId(){$("li#checkid").addClass("disabled").removeClass("enabled")}function EnableImageListByCheckId(){$("li#checkid").removeClass("disabled").addClass("enabled")}function ClearAllImagesForCheckId(){var n=$("#CheckItemImages li").each(function(){$(this).fadeOut(FadeOutDelay).remove()});$("#NoImagePanel").each(function(){$(this).fadeOut(FadeOutDelay).remove()})}function ImagesForCheckItemLoaded(n,t,i,r){var f=i.length,e=$("ul #CheckItemImages"),u;$("#LoadingImages").hide();f>0?$.each(i,function(i,u){AddCheckItemImage(n,t,u,r)}):(u=NoImageUploadedTemplate(),e.append(u).fadeIn(FadeInDelay));$("li#checkid").fadeIn(FadeInDelay)}function ImagesForCheckItemLoadedJSON(n,t,i,r){var u=JSON.parse(i);ImagesForCheckItemLoaded(n,t,u,r)}function ImageDeleted(n,t,i,r){$("li#Image_"+i.toString()).fadeOut(FadeOutDelay,function(){ClearAllImagesForCheckId();ImagesForCheckItemLoadedJSON(n,t,r)})}function DeleteImage(n,t,i){if(confirm("Are you sure you want to delete this image permanently?"))return DisableImageListByCheckId(),$.ajax({type:"POST",url:"/Trip/DeleteImage",data:{abc:n,tripId:t,imageId:i},datatype:"html",success:function(r){ImageDeleted(n,t,i,r)},error:function(){$("li#Image_"+i.toString()).addClass("error").attr("title","This image could not be deleted, plese reload the page.");ClearAllImagesForCheckId();LoadImagesForCheckItems(n,t,!1)},complete:function(){EnableImageListByCheckId()}}),!1}function PreviewImage(n,t,i){var r="/Trip/ScanImageBase64?abc="+n.toString()+"&tripId="+t.toString()+"&imageId="+i.toString()+"&width=1024&firstPageOnly=false";OpenLoadingImagePopup(r)}function OpenLoadingImagePopup(n,t){var r=OpenDefaultPopup('<img src="/Images/loader_image.gif"/>',"<div class='loader'><\/div>"),i=$("<img>");$.ajax({type:"POST",url:n,data:{},datatype:"json",success:function(n){var r="data:"+n.ContentType+";base64,"+n.ImageData;i.attr("src",r);OpenDefaultImagePopup("",i.get(0));t!=null&&t()}})}function OpenDefaultImagePopup(n,t){return $defaultPopup=$("#DefaultPopup"),IsNullOrWhitespace(n)?$defaultPopup.find("div.panel-title").hide():$defaultPopup.find("div.panel-title").html(n).show(),$defaultPopup.find("div.panel-body").html(t),$.colorbox({photo:!0,inline:!0,href:"#DefaultPopup",reposition:!0,scrolling:!1,closeButton:!1,onComplete:function(){var n=$defaultPopup.find("div.panel-body img").outerWidth()+12;$(this).colorbox.resize({innerWidth:n})}}),$defaultPopup}function OpenDefaultPopup(n,t){return $defaultPopup=$("#DefaultPopup"),IsNullOrWhitespace(n)?$defaultPopup.find("div.panel-title").hide():$defaultPopup.find("div.panel-title").html(n).show(),IsNullOrWhitespace(t)?$defaultPopup.find("div.panel-body").hide():$defaultPopup.find("div.panel-body").html(t).show(),$.colorbox({inline:!0,href:"#DefaultPopup",reposition:!0,maxWidth:"100%",scrolling:!1,closeButton:!1}),$defaultPopup}function ColorboxConfirmPopup(n){n||(n={});n.yesText||(n.yesText="Yes");n.noText||(n.noText="No");n.titleHtml||(n.titleHtml="Confirm");n.bodyHtml||(n.bodyHtml="Are you sure?");n.href||(n.href="#DefaultConfirmPopup");var t=!1;$confirmPopup=$(n.href);IsNullOrWhitespace(n.titleHtml)?$confirmPopup.find("div.panel-heading").hide():$confirmPopup.find("div.panel-heading").html(n.titleHtml).show();IsNullOrWhitespace(n.bodyHtml)?$confirmPopup.find("div.panel-body").hide():$confirmPopup.find("div.panel-body").html(n.bodyHtml).show();$confirmPopup.find("#ConfirmPopupYesText").text(n.yesText);$confirmPopup.find("#ConfirmPopupNoText").text(n.noText);$confirmPopup.find("a#ConfirmPopupAccept").off("click").on("click",function(){t=!0;CloseColorboxPopup()});$confirmPopup.find("a#ConfirmPopupCancel").off("click").on("click",function(){CloseColorboxPopup()});$.colorbox({inline:!0,href:n.href,reposition:!0,maxWidth:"100%",scrolling:!1,closeButton:!1,onClosed:function(i){t&&(n.accept?n.accept(i):n.cancel&&n.cancel(i))}})}function CloseColorboxPopup(){$.colorbox.close()}function IsNullOrWhitespace(n){return n===null||/^\s*$/.test(n)}function CloseCheckItemFileUploadProgressPopup(){$("div#CheckitemUploadContainer").colorbox.close()}function CheckItemImagesSelected(n){for(var e,o,c,i,s,r="The following files are in a format that is not supported: ",u=!1,h=!1,t,f=0;f<n.files.length;f++){for(e=n.files[f],o=!1,t=0;t<n.sender.options.validation.allowedExtensions.length;t++)if(c=n.sender.options.validation.allowedExtensions[t],c.toLowerCase()==e.extension.toLowerCase()){o=!0;break}o==!1?(u==!1?u=!0:r=r+", ",r=r+e.name):h=!0}if(u==!0){for(i="The following file types are supported: ",t=0;t<n.sender.options.validation.allowedExtensions.length;t++)t>0&&(i=i+", "),i=i+n.sender.options.validation.allowedExtensions[t].substr(1);return ShowColorboxErrorPopup(r+".  "+i+".",500),h}s=$("div#CheckitemUploadContainer em.file-dropped");s.length?s.removeClass("file-dropped"):ShowCheckItemFileUploadProgressPopup()}function OpenUploadDialog(){$("input#files").click()}function ShowCheckItemFileUploadProgressPopup(){$.colorbox({href:"div#CheckitemUploadContainer",inline:!0,reposition:!0,width:"800px",minHeight:"200px"})}function ShowColorboxErrorPopup(n,t){$("div#divAjaxErrorPopup span#ErrorMessage").text(n);$("div#divAjaxErrorPopup span#ErrorCode").text(t);$.colorbox({href:"div#divAjaxErrorPopup",inline:!0,reposition:!0,scrolling:!1,closeButton:!1})}function AddDragEvents(){$(document).on("dragenter dragstart dragend dragleave dragover drag drop",function(n){n.stopPropagation();n.preventDefault();n.originalEvent.dataTransfer.effectAllowed="none";n.originalEvent.dataTransfer.dropEffect="none"});$("li .file-drop-zone").on("dragover",function(n){n.stopPropagation();n.preventDefault();$(this).addClass("file-drag");n.originalEvent.dataTransfer.effectAllowed="copy";n.originalEvent.dataTransfer.dropEffect="copy"});$("li .file-drop-zone").on("dragleave",function(n){n.stopPropagation();n.preventDefault();$(this).removeClass("file-drag")});$("li .file-drop-zone").on("drop",function(n){var t,i;n.stopPropagation();n.preventDefault();$(this).removeClass("file-drag");t=jQuery.Event("drop");t.originalEvent=n.originalEvent;i=$("div#CheckitemUploadContainer em");i.addClass("file-dropped");i.trigger(t)});$("ul.image_list").sortable({cancel:"",items:"li.sortable",connectWith:"",cursor:"move",revert:!0,containment:"#ImageMaintenanceImageList",placeholder:"sortable-placeholder",start:function(n,t){t.placeholder.html($(t.item).removeClass(".sortable").html())},over:function(){AddRemoveNoImageLoadedPlaceholders()},out:function(){AddRemoveNoImageLoadedPlaceholders()},update:function(n,t){if(this==t.item.parent()[0]){AddRemoveNoImageLoadedPlaceholders();var i=t.item.attr("data-contextid"),r=t.item.attr("data-tripid"),u=t.item.attr("data-imageid");ReorderImage(i,r,u,t.item.index()+1)}}});$("ul.image_list").disableSelection()}function AddRemoveNoImageLoadedPlaceholders(){$("ul.image_list").each(function(){if($(this).find("li.no-image-uploaded").remove(),$(this).find("li:not(.ui-sortable-helper)").length==0){var n=NoImageUploadedTemplate();$(this).append(n)}})}function ReorderImage(n,t,i,r){DisableImageListByCheckId();var u=$("Image_"+i).attr("data-page-number");return $.ajax({type:"POST",url:"/Trip/ReorderImage",data:{abc:n,tripId:t,imageId:i,pageId:r},datatype:"html",success:function(i){ImageReordered(n,t,i,u,r)},error:function(){$("li#Image_"+i.toString()).addClass("error").attr("title","This image could not be reordered, plese reload the page.");ClearAllImagesForCheckId(checkId);LoadImagesForCheckItems(companyId,driverId,checkId,!1)},complete:function(){EnableImageListByCheckId()}}),!1}function ImageReordered(n,t,i){ClearAllImagesForCheckId();ImagesForCheckItemLoadedJSON(n,t,i)}function ResizeCheckItemFileUploadProgressPopup(){$("div#CheckitemUploadContainer").colorbox.resize()}function CheckItemImageUploading(n){var t;n.data={actionTripId:$("#_NewTrip input[id='TripIdForTripDetail']").val()};ResizeCheckItemFileUploadProgressPopup();DisableImageListByCheckId();var i=Math.floor(Math.random()*99999999),u=UploadingImageTemplate({UploadNumber:i}),r=$("ul #CheckItemImages");r.prepend(u);r.find("li#NoImagePanel").remove();$("li#UploadingImage_"+i.toString()).fadeIn(FadeInDelay);t=n.XMLHttpRequest;t&&t.addEventListener("readystatechange",function f(){t.readyState==1&&(t.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.removeEventListener("readystatechange",f))})}function CheckItemImageUploadError(){var n=$("#CheckItemImages li[id^='UploadingImage_']").each(function(){$(this).remove()});EnableImageListByCheckId()}var ImageTemplate=null,LoadingImagesTemplate=null,NoImageUploadedTemplate=null,PreviewImageTemplate=null,UploadingImageTemplate=null,FadeInDelay=125,FadeOutDelay=125;